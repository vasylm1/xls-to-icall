<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Schedule Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1, h2 {
      color: #2c3e50;
    }
    .toolbox {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2980b9;
    }
    #downloadLink {
      display: none;
      margin-top: 15px;
    }
    .language-selector {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="language-selector">
    <select id="languageSelect" onchange="setLanguage()">
      <option value="en">English</option>
      <option value="pl">Polski</option>
      <option value="uk">Українська</option>
      <option value="tr">Türkçe</option>
      <option value="az">Azərbaycanca</option>
    </select>
  </div>

  <h1 id="mainTitle">Class Schedule to iCal Converter</h1>
  
  <div class="toolbox">
    <h2 id="convertTitle">Convert Schedule</h2>
    <label id="fileLabel">Select Excel file:</label>
    <input type="file" id="fileInput" accept=".xls,.xlsx">
    <button onclick="convertToIcs()" id="convertBtn">Convert to iCal</button>
    <a id="downloadLink" class="btn"></a>
  </div>

  <div class="toolbox">
    <h2 id="aboutTitle">About</h2>
    <p id="aboutText1">I'm a marketing professional with a background in office administration, technical support, and product marketing.</p>
    <p id="aboutText2">My work centers around supporting product launches, creating and maintaining marketing assets.</p>
    <a href="https://www.linkedin.com/in/vasyl-madei-399488247/" target="_blank" id="linkedinLink">LinkedIn Profile</a>
  </div>

  <script>
    // Translations
    const translations = {
      en: {
        mainTitle: "Class Schedule to iCal Converter",
        convertTitle: "Convert Schedule",
        fileLabel: "Select Excel file:",
        convertBtn: "Convert to iCal",
        downloadBtn: "Download ICS File",
        aboutTitle: "About",
        aboutText1: "I'm a marketing professional with a background in office administration, technical support, and product marketing.",
        aboutText2: "My work centers around supporting product launches, creating and maintaining marketing assets.",
        linkedinLink: "LinkedIn Profile",
        noFileError: "Please select an Excel file first",
        fileError: "Error processing file: "
      },
      pl: {
        mainTitle: "Konwerter planu zajęć do iCal",
        convertTitle: "Konwertuj plan",
        fileLabel: "Wybierz plik Excel:",
        convertBtn: "Konwertuj do iCal",
        downloadBtn: "Pobierz plik ICS",
        aboutTitle: "O mnie",
        aboutText1: "Jestem specjalistą ds. marketingu z doświadczeniem w administracji biurowej, wsparciu technicznym oraz marketingu produktowym.",
        aboutText2: "Moja praca koncentruje się na wsparciu wprowadzania produktów oraz tworzeniu materiałów marketingowych.",
        linkedinLink: "Profil LinkedIn",
        noFileError: "Proszę wybrać plik Excel",
        fileError: "Błąd przetwarzania pliku: "
      },
      uk: {
        mainTitle: "Конвертер розкладу занять у iCal",
        convertTitle: "Конвертувати розклад",
        fileLabel: "Виберіть файл Excel:",
        convertBtn: "Конвертувати в iCal",
        downloadBtn: "Завантажити файл ICS",
        aboutTitle: "Про мене",
        aboutText1: "Я маркетолог із досвідом у сфері офісного адміністрування, технічної підтримки та продуктового маркетингу.",
        aboutText2: "Моя робота зосереджена на підтримці запусків продуктів та створенні маркетингових матеріалів.",
        linkedinLink: "Профіль LinkedIn",
        noFileError: "Будь ласка, виберіть файл Excel",
        fileError: "Помилка обробки файлу: "
      },
      tr: {
        mainTitle: "Ders Programı iCal Dönüştürücü",
        convertTitle: "Programı Dönüştür",
        fileLabel: "Excel dosyası seçin:",
        convertBtn: "iCal'e Dönüştür",
        downloadBtn: "ICS Dosyasını İndir",
        aboutTitle: "Hakkımda",
        aboutText1: "Ofis yönetimi, teknik destek ve ürün pazarlama geçmişine sahip bir pazarlama profesyoneliyim.",
        aboutText2: "Çalışmalarım ürün lansmanlarını desteklemeye ve pazarlama materyalleri oluşturmaya odaklanıyor.",
        linkedinLink: "LinkedIn Profili",
        noFileError: "Lütfen önce bir Excel dosyası seçin",
        fileError: "Dosya işleme hatası: "
      },
      az: {
        mainTitle: "Dərs Cədvəli iCal Konvertoru",
        convertTitle: "Cədvəli Konvert et",
        fileLabel: "Excel faylını seçin:",
        convertBtn: "iCal-ə çevir",
        downloadBtn: "ICS Faylını Yüklə",
        aboutTitle: "Haqqımda",
        aboutText1: "Ofis administrasiyası, texniki dəstək və məhsul marketinqi təcrübəsi olan marketinq peşəkaran.",
        aboutText2: "İşim məhsul buraxılışlarını dəstəkləmək və marketinq materialları yaratmaq üzərində cəmlənib.",
        linkedinLink: "LinkedIn Profili",
        noFileError: "Zəhmət olmasa əvvəlcə Excel faylı seçin",
        fileError: "Fayl emalı xətası: "
      }
    };

    // Set language
    function setLanguage() {
      const lang = document.getElementById("languageSelect").value;
      const t = translations[lang];
      
      document.getElementById("mainTitle").textContent = t.mainTitle;
      document.getElementById("convertTitle").textContent = t.convertTitle;
      document.getElementById("fileLabel").textContent = t.fileLabel;
      document.getElementById("convertBtn").textContent = t.convertBtn;
      document.getElementById("downloadLink").textContent = t.downloadBtn;
      document.getElementById("aboutTitle").textContent = t.aboutTitle;
      document.getElementById("aboutText1").textContent = t.aboutText1;
      document.getElementById("aboutText2").textContent = t.aboutText2;
      document.getElementById("linkedinLink").textContent = t.linkedinLink;
    }

    /**
     * Converts Excel file to iCal format using local time
     */
    function convertToIcs() {
      const lang = document.getElementById("languageSelect").value;
      const t = translations[lang];
      const fileInput = document.getElementById('fileInput');
      
      if (!fileInput.files.length) {
        alert(t.noFileError);
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          // Parse Excel file
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

          // Generate iCal content
          let icsContent = [
            "BEGIN:VCALENDAR",
            "VERSION:2.0",
            "PRODID:-//Class Schedule Converter//EN",
            "CALSCALE:GREGORIAN"
          ].join("\n");

          // Process each row (skip header)
          for (let i = 1; i < json.length; i++) {
            const row = json[i];
            if (!row[0]) continue; // Skip empty rows

            // Map columns (same order as your file)
            const startDate = formatDate(row[0]); // Start date
            const endDate = formatDate(row[1] || row[0]); // End date
            const subjectCode = row[3] || ""; // Subject code
            const subjectName = row[4] || ""; // Subject name
            const group = row[6] || ""; // Group
            const lecturer = row[7] || ""; // Lecturer
            const room = row[9] || ""; // Room
            const status = row[10] || ""; // Status

            if (!startDate) {
              console.warn(`Skipping row ${i+1}: Invalid start date`);
              continue;
            }

            // Combine additional info into description
            const description = [
              `Subject Code: ${subjectCode}`,
              `Group: ${group}`,
              `Lecturer: ${lecturer}`,
              `Room: ${room}`,
              status && `Status: ${status}`
            ].filter(Boolean).join("\\n");

            // Add event to iCal (using local time)
            icsContent += [
              "\nBEGIN:VEVENT",
              `DTSTART:${startDate}`,
              `DTEND:${endDate}`,
              `SUMMARY:${escapeIcalText(subjectName)}`,
              `DESCRIPTION:${escapeIcalText(description)}`,
              `LOCATION:${escapeIcalText(room)}`,
              "END:VEVENT"
            ].filter(Boolean).join("\n");
          }

          icsContent += "\nEND:VCALENDAR";

          // Create download link
          const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
          const link = document.getElementById('downloadLink');
          link.href = URL.createObjectURL(blob);
          link.download = 'class_schedule.ics';
          link.style.display = 'inline-block';
          link.textContent = t.downloadBtn;
        } catch (error) {
          alert(t.fileError + error.message);
          console.error(error);
        }
      };
      reader.onerror = function() {
        alert(t.fileError);
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    /**
     * Formats date for iCal in local time (YYYYMMDDTHHMMSS)
     * Handles multiple date formats
     */
    function formatDate(dateStr) {
      if (!dateStr) return '';

      let date;
      
      // Handle Polish date format: "DD.MM.YYYY HH:mm"
      if (typeof dateStr === 'string') {
        const polishDate = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2})/);
        if (polishDate) {
          const [_, day, month, year, hours, minutes] = polishDate;
          date = new Date(`${year}-${month}-${day}T${hours}:${minutes}:00`);
        } else {
          // Fallback to JS Date parsing
          date = new Date(dateStr);
        }
      }
      // Handle Excel serial numbers
      else if (typeof dateStr === 'number') {
        date = new Date((dateStr - 25569) * 86400 * 1000);
      }
      // Handle JS Date objects
      else if (dateStr instanceof Date) {
        date = dateStr;
      }

      // Validate
      if (!date || isNaN(date.getTime())) {
        console.warn('Invalid date format:', dateStr);
        return '';
      }

      // Format in local time (no UTC conversion)
      const pad = n => n.toString().padStart(2, '0');
      return [
        date.getFullYear(),
        pad(date.getMonth() + 1),
        pad(date.getDate()),
        'T',
        pad(date.getHours()),
        pad(date.getMinutes()),
        pad(date.getSeconds())
      ].join('');
    }

    /**
     * Escapes text for iCal
     */
    function escapeIcalText(text) {
      return String(text)
        .replace(/\\/g, '\\\\')
        .replace(/,/g, '\\,')
        .replace(/;/g, '\\;')
        .replace(/\n/g, '\\n');
    }

    // Initialize
    window.onload = function() {
      setLanguage(); // Set default language
    };
  </script>
</body>
</html>