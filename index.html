<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konwerter Planu Zajęć AEH</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- The CSS remains the same as in your original file (lines 9-164) -->
</head>
<body>
  <!-- The HTML structure remains the same as in your original file (lines 166-224) -->
  
  <script>
    const translations = {
      en: {
        mainTitle: "📅 AEH Class Schedule Converter",
        fileLabel: "Select your schedule file:",
        convertText: "Convert to Calendar",
        downloadText: "Download ICS File",
        noFileError: "Please select a file first",
        invalidFileError: "The selected file is not a valid schedule file",
        fileError: "Error processing file: ",
        loadingText: "Processing your schedule...",
        fileProcessing: "Processing file...",
        invalidFormat: "Invalid file format. Please use .xls or .xlsx files only.",
        aboutTitle: "About Me",
        // ... rest of English translations
      },
      pl: {
        mainTitle: "📅 Konwerter Planu Zajęć AEH",
        fileLabel: "Wybierz plik z planem zajęć:",
        convertText: "Konwertuj do Kalendarza",
        downloadText: "Pobierz plik ICS",
        noFileError: "Proszę wybrać plik",
        invalidFileError: "Wybrany plik nie jest prawidłowym plikiem z planem zajęć",
        fileError: "Błąd przetwarzania pliku: ",
        loadingText: "Przetwarzanie planu zajęć...",
        fileProcessing: "Przetwarzanie pliku...",
        invalidFormat: "Nieprawidłowy format pliku. Użyj tylko plików .xls lub .xlsx.",
        aboutTitle: "O mnie",
        // ... rest of Polish translations
      },
      uk: {
        mainTitle: "📅 Конвертер Розкладу AEH",
        fileLabel: "Виберіть файл з розкладом:",
        convertText: "Конвертувати в Календар",
        downloadText: "Завантажити файл ICS",
        noFileError: "Будь ласка, виберіть файл",
        invalidFileError: "Вибраний файл не є валідним файлом з розкладом",
        fileError: "Помилка обробки файлу: ",
        loadingText: "Обробка вашого розкладу...",
        fileProcessing: "Обробка файлу...",
        invalidFormat: "Невірний формат файлу. Використовуйте лише файли .xls або .xlsx.",
        aboutTitle: "Про мене",
        // ... rest of Ukrainian translations
      }
    };

    function validateRowData(row) {
      if (!row || !Array.isArray(row)) return false;
      if (!row[0] || !row[1] || !row[4]) return false; // Check for required fields
      return true;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      
      // Handle Excel date numbers
      if (typeof dateStr === 'number') {
        const date = new Date(Math.round((dateStr - 25569) * 86400 * 1000));
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}${month}${day}T${hour}${minute}00`;
      }
      
      // Handle string dates in format DD.MM.YYYY HH:mm
      if (typeof dateStr === 'string') {
        const plMatch = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4})\s*(\d{2}):(\d{2})/);
        if (plMatch) {
          const [_, day, month, year, hour, minute] = plMatch;
          return `${year}${month}${day}T${hour}${minute}00`;
        }
      }
      
      // Try parsing as regular date
      const date = new Date(dateStr);
      if (!isNaN(date.getTime())) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}${month}${day}T${hour}${minute}00`;
      }
      
      return '';
    }

    function escapeIcalText(text) {
      return String(text || '')
        .replace(/\\/g, '\\\\')
        .replace(/,/g, '\\,')
        .replace(/;/g, '\\;')
        .replace(/\n/g, '\\n');
    }

    function validateExcelHeaders(headers) {
      const requiredColumns = [
        'data rozpoczęcia',
        'data zakończenia',
        'nazwa pełna przedmiotu'
      ];
      
      const lowerHeaders = headers.map(h => String(h).toLowerCase().trim());
      return requiredColumns.every(col => 
        lowerHeaders.some(h => h.includes(col.toLowerCase()))
      );
    }

    function convertToIcs() {
      const lang = document.getElementById("languageSelectConverter").value;
      const t = translations[lang];
      const fileInput = document.getElementById("fileInput");
      
      if (!fileInput.files.length) {
        showError(t.noFileError);
        return;
      }
      
      const loadingIndicator = document.getElementById("loadingIndicator");
      const convertBtn = document.getElementById("convertBtn");
      const downloadLink = document.getElementById("downloadLink");
      
      // Hide download link and show loading
      downloadLink.style.display = 'none';
      loadingIndicator.style.display = 'block';
      convertBtn.disabled = true;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          let wb;
          try {
            wb = XLSX.read(data, { type: 'array' });
          } catch (error) {
            throw new Error(t.invalidFileError);
          }
          
          if (!wb || !wb.SheetNames || wb.SheetNames.length === 0) {
            throw new Error(t.invalidFileError);
          }
          
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
          
          if (json.length < 2) {
            throw new Error(t.invalidFileError);
          }
          
          const headers = json[0].map(h => String(h).trim());
          if (!validateExcelHeaders(headers)) {
            throw new Error(t.invalidFileError);
          }
          
          // Build ICS file content
          let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//AEH Schedule Converter//EN
CALSCALE:GREGORIAN
BEGIN:VTIMEZONE
TZID:Europe/Warsaw
BEGIN:STANDARD
DTSTART:19701025T030000
RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10
TZOFFSETFROM:+0200
TZOFFSETTO:+0100
TZNAME:CET
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19700329T020000
RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=3
TZOFFSETFROM:+0100
TZOFFSETTO:+0200
TZNAME:CEST
END:DAYLIGHT
END:VTIMEZONE
`;
          
          for (let i = 1; i < json.length; i++) {
            const row = json[i];
            if (!validateRowData(row)) continue;
            
            const start = formatDate(row[0]);
            const end = formatDate(row[1]);
            const hours = row[2];
            const summary = row[4];
            const groupThematic = row[5];
            const groupClass = row[6];
            const lecturer = row[7];
            const stageType = row[8];
            const deanGroups = row[9];
            const room = row[10] || '';
            
            if (!start || !end || !summary) continue;

            const description = escapeIcalText([
              groupThematic && `Grupa tematyczna: ${groupThematic}`,
              groupClass && `Grupa zajęciowa: ${groupClass}`,
              lecturer && `Wykładowca: ${lecturer}`,
              hours && `Godziny: ${hours}`,
              stageType && `Etap: ${stageType}`,
              deanGroups && `Grupy: ${deanGroups.toString().replace(/\n/g, ', ')}`
            ].filter(Boolean).join("\\n"));
            
            const location = room.toLowerCase().includes('teams') 
              ? 'Microsoft Teams' 
              : room.replace(/Teams/g, '').trim();
            
            ics += `BEGIN:VEVENT
DTSTART;TZID=Europe/Warsaw:${start}
DTEND;TZID=Europe/Warsaw:${end}
SUMMARY:${escapeIcalText(summary)}
${description ? `DESCRIPTION:${description}\n` : ''}${location ? `LOCATION:${escapeIcalText(location)}\n` : ''}UID:${Date.now()}-${i}@aeh-converter
END:VEVENT
`;
          }
          
          ics += 'END:VCALENDAR';
          
          const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
          const link = document.getElementById('downloadLink');
          if (link.href) {
            URL.revokeObjectURL(link.href); // Clean up previous URL
          }
          link.href = URL.createObjectURL(blob);
          link.style.display = 'inline-block';
          
        } catch (err) {
          showError(t.fileError + err.message);
        } finally {
          loadingIndicator.style.display = 'none';
          convertBtn.disabled = false;
        }
      };
      
      reader.onerror = function() {
        showError(t.fileError + reader.error);
        loadingIndicator.style.display = 'none';
        convertBtn.disabled = false;
      };
      
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function showError(message) {
      const errorElement = document.getElementById("fileError");
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-content').forEach(tc => {
        tc.classList.remove('active');
        tc.setAttribute('hidden', 'true');
      });
      
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).setAttribute('aria-selected', 'true');
      document.getElementById(tab).classList.add('active');
      document.getElementById(tab).removeAttribute('hidden');
    }

    function setLanguage(lang) {
      document.getElementById("languageSelectConverter").value = lang;
      document.getElementById("languageSelectAbout").value = lang;
      
      const t = translations[lang];
      for (const key in t) {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
      }
    }

    window.onload = () => {
      setLanguage('pl');
      
      document.getElementById("fileInput").addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById("fileInfo");
        const convertBtn = document.getElementById("convertBtn");
        const errorElement = document.getElementById("fileError");
        const downloadLink = document.getElementById("downloadLink");
        const lang = document.getElementById("languageSelectConverter").value;
        const t = translations[lang];
        
        errorElement.style.display = 'none';
        downloadLink.style.display = 'none';
        
        if (file) {
          const fileExtension = file.name.split('.').pop().toLowerCase();
          if (!['xls', 'xlsx'].includes(fileExtension)) {
            showError(t.invalidFormat);
            convertBtn.disabled = true;
            return;
          }
          fileInfo.textContent = `${t.fileLabel} ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          convertBtn.disabled = false;
        } else {
          fileInfo.textContent = '';
          convertBtn.disabled = true;
        }
      });
    };
  </script>
</body>
</html>